TYPE=TRIGGERS
triggers='CREATE DEFINER=`racktables`@`%` TRIGGER `EntityLink-before-insert` BEFORE INSERT ON `EntityLink` FOR EACH ROW\nEntityLinkTrigger:BEGIN\n  DECLARE parent_objtype, child_objtype, count INTEGER;\n\n  # forbid linking an entity to itself\n  IF NEW.parent_entity_type = NEW.child_entity_type AND NEW.parent_entity_id = NEW.child_entity_id THEN\n    SET NEW.parent_entity_id = NULL;\n    LEAVE EntityLinkTrigger;\n  END IF;\n\n  # in some scenarios, only one parent is allowed\n  CASE CONCAT(NEW.parent_entity_type, \'.\', NEW.child_entity_type)\n    WHEN \'location.location\' THEN\n      SELECT COUNT(*) INTO count FROM EntityLink WHERE parent_entity_type = \'location\' AND child_entity_type = \'location\' AND child_entity_id = NEW.child_entity_id;\n    WHEN \'location.row\' THEN\n      SELECT COUNT(*) INTO count FROM EntityLink WHERE parent_entity_type = \'location\' AND child_entity_type = \'row\' AND child_entity_id = NEW.child_entity_id;\n    WHEN \'row.rack\' THEN\n      SELECT COUNT(*) INTO count FROM EntityLink WHERE parent_entity_type = \'row\' AND child_entity_type = \'rack\' AND child_entity_id = NEW.child_entity_id;\n    ELSE\n      # some other scenario, assume it is valid\n      SET count = 0;\n  END CASE; \n  IF count > 0 THEN\n    SET NEW.parent_entity_id = NULL;\n    LEAVE EntityLinkTrigger;\n  END IF;\n\n  IF NEW.parent_entity_type = \'object\' AND NEW.child_entity_type = \'object\' THEN\n    # lock objects to prevent concurrent link establishment\n    SELECT objtype_id INTO parent_objtype FROM Object WHERE id = NEW.parent_entity_id FOR UPDATE;\n    SELECT objtype_id INTO child_objtype FROM Object WHERE id = NEW.child_entity_id FOR UPDATE;\n\n    # only permit the link if object types are compatibile\n    SELECT COUNT(*) INTO count FROM ObjectParentCompat WHERE parent_objtype_id = parent_objtype AND child_objtype_id = child_objtype;\n    IF count = 0 THEN\n      SET NEW.parent_entity_id = NULL;\n    END IF;\n  END IF;\nEND' 'CREATE DEFINER=`racktables`@`%` TRIGGER `EntityLink-before-update` BEFORE UPDATE ON `EntityLink` FOR EACH ROW\nEntityLinkTrigger:BEGIN\n  DECLARE parent_objtype, child_objtype, count INTEGER;\n\n  # forbid linking an entity to itself\n  IF NEW.parent_entity_type = NEW.child_entity_type AND NEW.parent_entity_id = NEW.child_entity_id THEN\n    SET NEW.parent_entity_id = NULL;\n    LEAVE EntityLinkTrigger;\n  END IF;\n\n  # in some scenarios, only one parent is allowed\n  CASE CONCAT(NEW.parent_entity_type, \'.\', NEW.child_entity_type)\n    WHEN \'location.location\' THEN\n      SELECT COUNT(*) INTO count FROM EntityLink WHERE parent_entity_type = \'location\' AND child_entity_type = \'location\' AND child_entity_id = NEW.child_entity_id AND id != NEW.id;\n    WHEN \'location.row\' THEN\n      SELECT COUNT(*) INTO count FROM EntityLink WHERE parent_entity_type = \'location\' AND child_entity_type = \'row\' AND child_entity_id = NEW.child_entity_id AND id != NEW.id;\n    WHEN \'row.rack\' THEN\n      SELECT COUNT(*) INTO count FROM EntityLink WHERE parent_entity_type = \'row\' AND child_entity_type = \'rack\' AND child_entity_id = NEW.child_entity_id AND id != NEW.id;\n    ELSE\n      # some other scenario, assume it is valid\n      SET count = 0;\n  END CASE; \n  IF count > 0 THEN\n    SET NEW.parent_entity_id = NULL;\n    LEAVE EntityLinkTrigger;\n  END IF;\n\n  IF NEW.parent_entity_type = \'object\' AND NEW.child_entity_type = \'object\' THEN\n    # lock objects to prevent concurrent link establishment\n    SELECT objtype_id INTO parent_objtype FROM Object WHERE id = NEW.parent_entity_id FOR UPDATE;\n    SELECT objtype_id INTO child_objtype FROM Object WHERE id = NEW.child_entity_id FOR UPDATE;\n\n    # only permit the link if object types are compatibile\n    SELECT COUNT(*) INTO count FROM ObjectParentCompat WHERE parent_objtype_id = parent_objtype AND child_objtype_id = child_objtype;\n    IF count = 0 THEN\n      SET NEW.parent_entity_id = NULL;\n    END IF;\n  END IF;\nEND'
sql_modes=1415577600 1415577600
definers='racktables@%' 'racktables@%'
client_cs_names='utf8' 'utf8'
connection_cl_names='utf8_general_ci' 'utf8_general_ci'
db_cl_names='utf8_unicode_ci' 'utf8_unicode_ci'
created=155753583363 155753583370
